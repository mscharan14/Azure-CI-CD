pipeline {
  agent any

  environment {
    PREFIX = "srchan"
    ACR_NAME = "${env.PREFIX}acr01"   // update to your ACR if different
  }

  stages {
    stage('Prepare') {
      steps {
        script {
          env.GIT_COMMIT = sh(script: "git rev-parse --short HEAD", returnStdout:true).trim()
        }
        echo "Commit: ${env.GIT_COMMIT}"
      }
    }

    stage('Build & Test (in ACR)') {
      steps {
        withCredentials([file(credentialsId: 'azure-sp-json', variable: 'AZURE_AUTH')]) {
          // Login using service principal json
          sh 'az login --service-principal --sdk-auth @$AZURE_AUTH >/dev/null'
          // Build image on ACR. Dockerfile must run tests and fail build if tests fail.
          sh "az acr build --registry ${ACR_NAME} --image flask-todo:${GIT_COMMIT} --file docker/Dockerfile ."
        }
      }
    }

    stage('Update Helm values & push') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'git-creds', usernameVariable: 'GIT_USER', passwordVariable:'GIT_TOKEN')]) {
          sh '''
            set -e
            git config user.email "jenkins@example.com"
            git config user.name "jenkins-ci"
            # clone to a temp dir so Jenkins workspace stays clean
            rm -rf repo || true
            git clone https://$GIT_USER:$GIT_TOKEN@github.com/mscharan14/Azure-CI-CD.git repo
            cd repo
            # update the chart values
            sed -i "s/tag: .*/tag: \\"${GIT_COMMIT}\\"/" helm/todo-chart/values.yaml || true
            git add helm/todo-chart/values.yaml
            git commit -m "ci: bump image tag to ${GIT_COMMIT}" || true
            git push https://$GIT_USER:$GIT_TOKEN@github.com/mscharan14/Azure-CI-CD.git HEAD:master
          '''
        }
      }
    }
  }

  post {
    always { echo "Pipeline finished" }
    success { echo "Pipeline succeeded" }
    failure { echo "Pipeline failed" }
  }
}

